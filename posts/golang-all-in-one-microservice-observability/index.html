<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-51327142-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-51327142-1")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-CRQFNB39T1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CRQFNB39T1")</script><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>All-in-One Solution for observability in Go Microservices using Prometheus, Loki, Promtail, Grafana and Tempo | İlker Korkut</title>
<link rel=canonical href=https://ilkerkorkut.com/posts/golang-all-in-one-microservice-observability/><meta name=description content="thoughts, stories and ideas about software development."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://ilkerkorkut.com/posts/golang-all-in-one-microservice-observability/"><meta property="og:site_name" content="İlker Korkut"><meta property="og:title" content="All-in-One Solution for observability in Go Microservices using Prometheus, Loki, Promtail, Grafana and Tempo"><meta property="og:description" content="In this post, I will try to demonstrate how to build a complete observability solution for a go microservice with Prometheus, Loki, Promtail, Tempo and interacting with the Grafana dashboard. In API layer, I will use Fiber framework for building a simple service. If you are in a hurry, you can find the source code in this section.
Prerequisites:
Go 1.22 Docker (and docker-compose) While gathering logs, I also create a kafka sink to consuming logs on promtail for loki."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-26T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-26T16:08:33+03:00"><meta property="article:tag" content="Prometheus"><meta property="article:tag" content="Loki"><meta property="article:tag" content="Promtail"><meta property="article:tag" content="Grafana"><meta property="article:tag" content="Tempo"><meta property="article:tag" content="Go"><meta name=twitter:card content="summary"><meta name=twitter:title content="All-in-One Solution for observability in Go Microservices using Prometheus, Loki, Promtail, Grafana and Tempo"><meta name=twitter:description content="In this post, I will try to demonstrate how to build a complete observability solution for a go microservice with Prometheus, Loki, Promtail, Tempo and interacting with the Grafana dashboard. In API layer, I will use Fiber framework for building a simple service. If you are in a hurry, you can find the source code in this section.
Prerequisites:
Go 1.22 Docker (and docker-compose) While gathering logs, I also create a kafka sink to consuming logs on promtail for loki."><link rel=stylesheet href=https://ilkerkorkut.com/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://ilkerkorkut.com/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://ilkerkorkut.com/><div id=logo style="background-image:url(https://www.gravatar.com/avatar/ffe896063870988d78a9931b4bd8d718?s=100&d=identicon)"></div><div id=title><h1>İlker Korkut</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/posts/>Posts</a></li></ul></div></header><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/posts/>Posts</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://ilkerkorkut.com/posts/golang-find-pid-with-name/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&text=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&title=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&is_video=false&description=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo&body=Check out this article: https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&title=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&title=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&name=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo&description=In%20this%20post%2c%20I%20will%20try%20to%20demonstrate%20how%20to%20build%20a%20complete%20observability%20solution%20for%20a%20go%20microservice%20with%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Tempo%20and%20interacting%20with%20the%20Grafana%20dashboard.%20In%20API%20layer%2c%20I%20will%20use%20Fiber%20framework%20for%20building%20a%20simple%20service.%20If%20you%20are%20in%20a%20hurry%2c%20you%20can%20find%20the%20source%20code%20in%20this%20section.%0aPrerequisites%3a%0aGo%201.22%20Docker%20%28and%20docker-compose%29%20While%20gathering%20logs%2c%20I%20also%20create%20a%20kafka%20sink%20to%20consuming%20logs%20on%20promtail%20for%20loki." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&t=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#architecture>Architecture</a></li><li><a href=#prometheus-integration>Prometheus Integration</a></li><li><a href=#sending-custom-metrics-to-prometheus>Sending Custom Metrics to Prometheus</a></li><li><a href=#setting-up-logging-with-zap-to-sink-into-kafka>Setting up Logging with Zap to Sink into Kafka</a></li><li><a href=#distributed-tracing-with-tempo-via-opentelemetry>Distributed Tracing with Tempo via OpenTelemetry</a></li><li><a href=#setting-up-simple-go-microservice-with-fiber>Setting up Simple Go Microservice with Fiber</a></li><li><a href=#exploring-via-grafana-dashboard>Exploring via Grafana Dashboard</a></li><li><a href=#source-code-and-how-to-run-the-application>Source Code and How to run the Application</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">All-in-One Solution for observability in Go Microservices using Prometheus, Loki, Promtail, Grafana and Tempo</h1><div class=meta><div class=postdate><time datetime="2024-06-26 00:00:00 +0000 UTC" itemprop=datePublished>June 26, 2024</time>
(Updated: <time datetime="2024-06-26 16:08:33 +0300 +0300" itemprop=dateModified>June 26, 2024</time>)</div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/go>go</a>
,
<a class=category-link href=/categories/microservices>microservices</a>
,
<a class=category-link href=/categories/observability>observability</a>
,
<a class=category-link href=/categories/monitoring>monitoring</a>
,
<a class=category-link href=/categories/distributed-tracing>distributed tracing</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/prometheus rel=tag>prometheus</a>
,
<a class=tag-link href=/tags/loki rel=tag>loki</a>
,
<a class=tag-link href=/tags/promtail rel=tag>promtail</a>
,
<a class=tag-link href=/tags/grafana rel=tag>grafana</a>
,
<a class=tag-link href=/tags/tempo rel=tag>tempo</a>
,
<a class=tag-link href=/tags/go rel=tag>go</a>
,
<a class=tag-link href=/tags/golang rel=tag>golang</a></div></div></header><div class=content itemprop=articleBody><p>In this post, I will try to demonstrate how to build a complete observability solution for a go microservice with Prometheus, Loki, Promtail, Tempo and interacting with the Grafana dashboard. In API layer, I will use Fiber framework for building a simple service. If you are in a hurry, you can find the source code in <a href=/posts/golang-all-in-one-microservice-observability/#source-code-and-how-to-run-the-application>this</a> section.</p><p>Prerequisites:</p><ul><li>Go 1.22</li><li>Docker (and docker-compose)</li></ul><p>While gathering logs, I also create a kafka sink to consuming logs on promtail for loki. Promtail has flexibility to gather logs from files or different data sources as well.</p><h2 id=architecture>Architecture</h2><p><img alt="Go Observability Architecture" src=/images/go-observability/go-observability.png></p><h2 id=prometheus-integration>Prometheus Integration</h2><p>We create a factory for Prometheus integration so that, this factory can handle the registring the prometheus registry and also http handler for prometheus metrics which can be used in the application.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>type</span> PrometheusFactory <span style=color:#8be9fd;font-style:italic>interface</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	<span style=color:#50fa7b>InitHandler</span>() http.Handler
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>type</span> prometheusFactory <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	registry <span style=color:#ff79c6>*</span>prometheus.Registry
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>NewPrometheusFactory</span>(cs <span style=color:#ff79c6>...</span>prometheus.Collector) PrometheusFactory {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	f <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&amp;</span>prometheusFactory{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	f.registry = f.<span style=color:#50fa7b>initRegistry</span>(cs)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	<span style=color:#ff79c6>return</span> f
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd;font-style:italic>func</span> (f <span style=color:#ff79c6>*</span>prometheusFactory) <span style=color:#50fa7b>InitHandler</span>() http.Handler {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#ff79c6>return</span> promhttp.<span style=color:#50fa7b>HandlerFor</span>(f.registry, promhttp.HandlerOpts{Registry: f.registry})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#8be9fd;font-style:italic>func</span> (f <span style=color:#ff79c6>*</span>prometheusFactory) <span style=color:#50fa7b>initRegistry</span>(cs []prometheus.Collector) <span style=color:#ff79c6>*</span>prometheus.Registry {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	reg <span style=color:#ff79c6>:=</span> prometheus.<span style=color:#50fa7b>NewRegistry</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>	defaultCs <span style=color:#ff79c6>:=</span> []prometheus.Collector{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>		collectors.<span style=color:#50fa7b>NewGoCollector</span>(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>		collectors.<span style=color:#50fa7b>NewProcessCollector</span>(collectors.ProcessCollectorOpts{}),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	fCS <span style=color:#ff79c6>:=</span> <span style=color:#8be9fd;font-style:italic>make</span>([]prometheus.Collector, <span style=color:#bd93f9>0</span>, <span style=color:#8be9fd;font-style:italic>len</span>(defaultCs)<span style=color:#ff79c6>+</span><span style=color:#8be9fd;font-style:italic>len</span>(cs))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>	fCS = <span style=color:#8be9fd;font-style:italic>append</span>(fCS, defaultCs<span style=color:#ff79c6>...</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>	<span style=color:#ff79c6>for</span> _, c <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> cs {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>		<span style=color:#ff79c6>if</span> c <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>			fCS = <span style=color:#8be9fd;font-style:italic>append</span>(fCS, c)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	reg.<span style=color:#50fa7b>MustRegister</span>(fCS<span style=color:#ff79c6>...</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>	<span style=color:#ff79c6>return</span> reg
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>}
</span></span></code></pre></div><p>When we started the application with the following factory instance and tying the handler to the <code>/metrics</code> endpoint, we can see the metrics on the response.</p><p>Following code blocks, shows us how to bind the handler to the go-fiber router. Actually, it is basically <em>net/http</em> handler.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>app.<span style=color:#50fa7b>Get</span>(<span style=color:#f1fa8c>&#34;/metrics&#34;</span>, adaptor.<span style=color:#50fa7b>HTTPHandler</span>(a.PrometheusFactory.<span style=color:#50fa7b>InitHandler</span>()))
</span></span></code></pre></div><p>During this definition, just to be make sure it shouldn&rsquo;t be under any business logic related middleware or that can affect the metrics. By applying this approach, we can play with any metrics on any middleware or handler.</p><h2 id=sending-custom-metrics-to-prometheus>Sending Custom Metrics to Prometheus</h2><p>We can define any custom metrics metrics and register them to the prometheus registry. For instance, on following code block we defined a counter metric for counting the requests.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>package</span> metric
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>import</span> <span style=color:#f1fa8c>&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>var</span> TestCounter = prometheus.<span style=color:#50fa7b>NewCounter</span>(prometheus.CounterOpts{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	Namespace:   <span style=color:#f1fa8c>&#34;myapp&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	Subsystem:   <span style=color:#f1fa8c>&#34;api&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	Name:        <span style=color:#f1fa8c>&#34;request_counter&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	Help:        <span style=color:#f1fa8c>&#34;Counter for requests&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	ConstLabels: <span style=color:#ff79c6>nil</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>})
</span></span></code></pre></div><p>Registering the custom metrics to the prometheus registry is also simple as following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>promFactory <span style=color:#ff79c6>:=</span> factory.<span style=color:#50fa7b>NewPrometheusFactory</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>		metric.TestCounter,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>)
</span></span></code></pre></div><p>Also we can create a request counter to observe that custom metric inside the application.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>package</span> middleware
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#f1fa8c>&#34;github.com/gofiber/fiber/v2&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#f1fa8c>&#34;github.com/ilkerkorkut/go-examples/microservice/observability/internal/metric&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>MetricsMiddleware</span>() <span style=color:#8be9fd;font-style:italic>func</span>(c <span style=color:#ff79c6>*</span>fiber.Ctx) <span style=color:#8be9fd>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>func</span>(c <span style=color:#ff79c6>*</span>fiber.Ctx) (err <span style=color:#8be9fd>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		metric.TestCounter.<span style=color:#50fa7b>Add</span>(<span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		<span style=color:#ff79c6>return</span> c.<span style=color:#50fa7b>Next</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span></code></pre></div><h2 id=setting-up-logging-with-zap-to-sink-into-kafka>Setting up Logging with Zap to Sink into Kafka</h2><p>Zap logging library is commonly used in go applications. It is fast and flexible. So, we will use it in our application. We can define a logger factory to create a logger instance with some configurations.</p><p>First we can create a kafka sink for the logger. We will use IBM/sarama kafka client for that purpose.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>package</span> logging
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#f1fa8c>&#34;time&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	<span style=color:#f1fa8c>&#34;github.com/IBM/sarama&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>type</span> kafkaSink <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	producer sarama.SyncProducer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	topic    <span style=color:#8be9fd>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#8be9fd;font-style:italic>func</span> (s kafkaSink) <span style=color:#50fa7b>Write</span>(b []<span style=color:#8be9fd>byte</span>) (<span style=color:#8be9fd>int</span>, <span style=color:#8be9fd>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	_, _, err <span style=color:#ff79c6>:=</span> s.producer.<span style=color:#50fa7b>SendMessage</span>(<span style=color:#ff79c6>&amp;</span>sarama.ProducerMessage{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		Topic: s.topic,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		Key:   sarama.<span style=color:#50fa7b>StringEncoder</span>(time.<span style=color:#50fa7b>Now</span>().<span style=color:#50fa7b>String</span>()),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		Value: sarama.<span style=color:#50fa7b>ByteEncoder</span>(b),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>len</span>(b), err
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd;font-style:italic>func</span> (s kafkaSink) <span style=color:#50fa7b>Sync</span>() <span style=color:#8be9fd>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#8be9fd;font-style:italic>func</span> (s kafkaSink) <span style=color:#50fa7b>Close</span>() <span style=color:#8be9fd>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>}
</span></span></code></pre></div><p>You can ask why there is <code>Sync</code> and <code>Close</code> methods.</p><p>When we take a look tha zap&rsquo;s <code>Sink</code> interface, it derives from <code>WriteSyncer</code> and <code>io.Closer</code> interfaces. Because of that we need to implement all of the methods, this is golang interface&rsquo;s nature.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>type</span> Sink <span style=color:#8be9fd;font-style:italic>interface</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	zapcore.WriteSyncer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>	io.Closer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>Then, we can create a simple application logger initializer as follows;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>package</span> logging
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>import</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#f1fa8c>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#f1fa8c>&#34;log&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	<span style=color:#f1fa8c>&#34;net/url&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#f1fa8c>&#34;strings&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#f1fa8c>&#34;github.com/IBM/sarama&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	<span style=color:#f1fa8c>&#34;go.uber.org/zap&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#f1fa8c>&#34;go.uber.org/zap/zapcore&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>InitLogger</span>(lvl <span style=color:#8be9fd>string</span>, kafkaBrokers []<span style=color:#8be9fd>string</span>) (<span style=color:#ff79c6>*</span>zap.Logger, <span style=color:#8be9fd>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	level, err <span style=color:#ff79c6>:=</span> <span style=color:#50fa7b>parseLevel</span>(lvl)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>, err
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>getLogger</span>(level, kafkaBrokers), <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>getLogger</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	level zapcore.Level,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	kafkaBrokers []<span style=color:#8be9fd>string</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>) <span style=color:#ff79c6>*</span>zap.Logger {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>	kafkaURL <span style=color:#ff79c6>:=</span> url.URL{Scheme: <span style=color:#f1fa8c>&#34;kafka&#34;</span>, Host: strings.<span style=color:#50fa7b>Join</span>(kafkaBrokers, <span style=color:#f1fa8c>&#34;,&#34;</span>)}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>	ec <span style=color:#ff79c6>:=</span> zap.<span style=color:#50fa7b>NewProductionEncoderConfig</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	ec.EncodeName = zapcore.FullNameEncoder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	ec.EncodeName = zapcore.FullNameEncoder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>	ec.EncodeTime = zapcore.RFC3339TimeEncoder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>	ec.EncodeDuration = zapcore.MillisDurationEncoder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	ec.EncodeLevel = zapcore.CapitalLevelEncoder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	ec.EncodeCaller = zapcore.ShortCallerEncoder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>	ec.NameKey = <span style=color:#f1fa8c>&#34;logger&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>	ec.MessageKey = <span style=color:#f1fa8c>&#34;message&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>	ec.LevelKey = <span style=color:#f1fa8c>&#34;level&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>	ec.TimeKey = <span style=color:#f1fa8c>&#34;timestamp&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>	ec.CallerKey = <span style=color:#f1fa8c>&#34;caller&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>	ec.StacktraceKey = <span style=color:#f1fa8c>&#34;trace&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>	ec.LineEnding = zapcore.DefaultLineEnding
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	ec.ConsoleSeparator = <span style=color:#f1fa8c>&#34; &#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	zapConfig <span style=color:#ff79c6>:=</span> zap.Config{}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>	zapConfig.Level = zap.<span style=color:#50fa7b>NewAtomicLevelAt</span>(level)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>	zapConfig.Encoding = <span style=color:#f1fa8c>&#34;json&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>	zapConfig.EncoderConfig = ec
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>	zapConfig.OutputPaths = []<span style=color:#8be9fd>string</span>{<span style=color:#f1fa8c>&#34;stdout&#34;</span>, kafkaURL.<span style=color:#50fa7b>String</span>()}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	zapConfig.ErrorOutputPaths = []<span style=color:#8be9fd>string</span>{<span style=color:#f1fa8c>&#34;stderr&#34;</span>, kafkaURL.<span style=color:#50fa7b>String</span>()}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>	<span style=color:#ff79c6>if</span> kafkaBrokers <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> <span style=color:#ff79c6>||</span> <span style=color:#8be9fd;font-style:italic>len</span>(kafkaBrokers) &gt; <span style=color:#bd93f9>0</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>		err <span style=color:#ff79c6>:=</span> zap.<span style=color:#50fa7b>RegisterSink</span>(<span style=color:#f1fa8c>&#34;kafka&#34;</span>, <span style=color:#8be9fd;font-style:italic>func</span>(_ <span style=color:#ff79c6>*</span>url.URL) (zap.Sink, <span style=color:#8be9fd>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>			config <span style=color:#ff79c6>:=</span> sarama.<span style=color:#50fa7b>NewConfig</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>			config.Producer.Return.Successes = <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>			producer, err <span style=color:#ff79c6>:=</span> sarama.<span style=color:#50fa7b>NewSyncProducer</span>(kafkaBrokers, config)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>			<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>				log.<span style=color:#50fa7b>Fatal</span>(<span style=color:#f1fa8c>&#34;failed to create kafka producer&#34;</span>, err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>				<span style=color:#ff79c6>return</span> kafkaSink{}, err
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>			<span style=color:#ff79c6>return</span> kafkaSink{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>				producer: producer,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>				topic:    <span style=color:#f1fa8c>&#34;application.logs&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>			}, <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>		<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>			log.<span style=color:#50fa7b>Fatal</span>(<span style=color:#f1fa8c>&#34;failed to register kafka sink&#34;</span>, err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>	zapLogger, err <span style=color:#ff79c6>:=</span> zapConfig.<span style=color:#50fa7b>Build</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>		zap.<span style=color:#50fa7b>AddCaller</span>(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>		zap.<span style=color:#50fa7b>AddStacktrace</span>(zapcore.ErrorLevel),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>	)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>	<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>		log.<span style=color:#50fa7b>Fatal</span>(<span style=color:#f1fa8c>&#34;failed to build zap logger&#34;</span>, err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>	<span style=color:#ff79c6>return</span> zapLogger
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>parseLevel</span>(lvl <span style=color:#8be9fd>string</span>) (zapcore.Level, <span style=color:#8be9fd>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span>	<span style=color:#ff79c6>switch</span> strings.<span style=color:#50fa7b>ToLower</span>(lvl) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86</span><span>	<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;debug&#34;</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87</span><span>		<span style=color:#ff79c6>return</span> zap.DebugLevel, <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88</span><span>	<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;info&#34;</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89</span><span>		<span style=color:#ff79c6>return</span> zap.InfoLevel, <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90</span><span>	<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;warn&#34;</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91</span><span>		<span style=color:#ff79c6>return</span> zap.WarnLevel, <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92</span><span>	<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;error&#34;</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93</span><span>		<span style=color:#ff79c6>return</span> zap.ErrorLevel, <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">94</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">95</span><span>	<span style=color:#ff79c6>return</span> zap.InfoLevel, fmt.<span style=color:#50fa7b>Errorf</span>(<span style=color:#f1fa8c>&#34;invalid log level &lt;%v&gt;&#34;</span>, lvl)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">96</span><span>}
</span></span></code></pre></div><p>We are covering the initial logger level, and registering kafka sink and default encoding congiruations. Just, keep in mind, there are some hard-coded parts like <code>application.logs</code> topic we will use it on kafka. You can define environment variables or applications configs for these kind of hard-coded values.</p><h2 id=distributed-tracing-with-tempo-via-opentelemetry>Distributed Tracing with Tempo via OpenTelemetry</h2><p>Tempo is open-source grafana&rsquo;s distributed tracing backend. It&rsquo;s quite simple and it can provide the tracing options like jaeger, zipkin, opentelemtry protocol etc. In this project, we will use the opentelemetry protocol to send the traces to tempo endpoint.</p><p>While defining the tracing we will use <a href=https://github.com/gofiber/contrib/tree/main/otelfiber>otelfiber</a> library to integrate the opentelemetry with fiber framework. It propagates the tracing context over the fiber&rsquo;s UserContext.</p><p>But at first we have to define our tracingprovider and exporter.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>exp, err <span style=color:#ff79c6>:=</span> factory.<span style=color:#50fa7b>NewOTLPExporter</span>(ctx, cm.<span style=color:#50fa7b>GetOTLPConfig</span>().OTLPEndpoint)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  log.<span style=color:#50fa7b>Printf</span>(<span style=color:#f1fa8c>&#34;failed to create OTLP exporter: %v&#34;</span>, err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>tp <span style=color:#ff79c6>:=</span> factory.<span style=color:#50fa7b>NewTraceProvider</span>(exp, cm.<span style=color:#50fa7b>GetAppConfig</span>().Name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>defer</span> <span style=color:#8be9fd;font-style:italic>func</span>() { _ = tp.<span style=color:#50fa7b>Shutdown</span>(ctx) }()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>otel.<span style=color:#50fa7b>SetTracerProvider</span>(tp)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>otel.<span style=color:#50fa7b>SetTextMapPropagator</span>(propagation.<span style=color:#50fa7b>NewCompositeTextMapPropagator</span>(propagation.TraceContext{}, propagation.Baggage{}))
</span></span></code></pre></div><p>Above codeblock defines the opentelemetry tracerprovider and exporter.</p><p>Then, we can define the fiber middleware for tracing as follows;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>app.<span style=color:#50fa7b>Use</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  otelfiber.<span style=color:#50fa7b>Middleware</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  otelfiber.<span style=color:#50fa7b>WithTracerProvider</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    a.TracerProvider,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  ),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  otelfiber.<span style=color:#50fa7b>WithNext</span>(<span style=color:#8be9fd;font-style:italic>func</span>(c <span style=color:#ff79c6>*</span>fiber.Ctx) <span style=color:#8be9fd>bool</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#ff79c6>return</span> c.<span style=color:#50fa7b>Path</span>() <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;/metrics&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  }),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>))
</span></span></code></pre></div><p>As you see, we can skip the tracing for the <code>/metrics</code> endpoint. Because, it is not a business logic in our application.</p><h2 id=setting-up-simple-go-microservice-with-fiber>Setting up Simple Go Microservice with Fiber</h2><p>We set a router handler with a simple http request to SWAPI<a href=https://swapi.dev/></a>. We will use this handler to demonstrate the observability features.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>func</span> (s <span style=color:#ff79c6>*</span>dataService) <span style=color:#50fa7b>GetData</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	ctx context.Context,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	id <span style=color:#8be9fd>string</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>) (<span style=color:#8be9fd;font-style:italic>map</span>[<span style=color:#8be9fd>string</span>]any, <span style=color:#8be9fd>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	span <span style=color:#ff79c6>:=</span> trace.<span style=color:#50fa7b>SpanFromContext</span>(ctx)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	span.<span style=color:#50fa7b>AddEvent</span>(<span style=color:#f1fa8c>&#34;Starting fake long running task&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	sleepTime <span style=color:#ff79c6>:=</span> <span style=color:#bd93f9>70</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	sleepTimeDuration <span style=color:#ff79c6>:=</span> time.<span style=color:#50fa7b>Duration</span>(sleepTime <span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>int</span>(time.Millisecond))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	time.<span style=color:#50fa7b>Sleep</span>(sleepTimeDuration)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	span.<span style=color:#50fa7b>AddEvent</span>(<span style=color:#f1fa8c>&#34;Done first fake long running task&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	span.<span style=color:#50fa7b>AddEvent</span>(<span style=color:#f1fa8c>&#34;Starting request to Star Wars API&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	s.logger.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		<span style=color:#50fa7b>With</span>(zap.<span style=color:#50fa7b>String</span>(<span style=color:#f1fa8c>&#34;traceID&#34;</span>, span.<span style=color:#50fa7b>SpanContext</span>().<span style=color:#50fa7b>TraceID</span>().<span style=color:#50fa7b>String</span>())).
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>		<span style=color:#50fa7b>Info</span>(<span style=color:#f1fa8c>&#34;Getting data&#34;</span>, zap.<span style=color:#50fa7b>String</span>(<span style=color:#f1fa8c>&#34;id&#34;</span>, id))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	res, err <span style=color:#ff79c6>:=</span> s.client.<span style=color:#50fa7b>StarWars</span>().<span style=color:#50fa7b>GetPerson</span>(ctx, id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>	<span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>		span.<span style=color:#50fa7b>RecordError</span>(err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>, err
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	span.<span style=color:#50fa7b>AddEvent</span>(<span style=color:#f1fa8c>&#34;Done request to Star Wars API&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	<span style=color:#ff79c6>return</span> res, <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>}
</span></span></code></pre></div><p>In this code block, we defined the span events and added http request context to resty client to trace external requests as well.
With this approach, it is able to trace databases or any external services requests from our microservice.</p><p>Also, during logging we can add trace id via getting it from span context;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>span.<span style=color:#50fa7b>SpanContext</span>().<span style=color:#50fa7b>TraceID</span>().<span style=color:#50fa7b>String</span>()
</span></span></code></pre></div><p>It will give ability while examining the logs also we can query the traces with the same trace id.</p><h2 id=exploring-via-grafana-dashboard>Exploring via Grafana Dashboard</h2><p>Firstly, you can see the metrics on both Grafana and Prometheus metrics endpoint;</p><p><img alt=explore-prometheus src=/images/go-observability/prometheus-metrics.png></p><p>Exploring the logs on Grafana via Loki datasource;</p><p><img alt=explore-loki src=/images/go-observability/loki-logs.png></p><p>Exploring the traces on Grafana via Tempo datasource;</p><p><img alt=explore-tempo src=/images/go-observability/tempo-tracing-1.png></p><p>Also you can see the much more detail on tempo dashboard;</p><p><img alt=explore-tempo-detail src=/images/go-observability/tempo-tracing-2.png></p><h2 id=source-code-and-how-to-run-the-application>Source Code and How to run the Application</h2><p>You can find the source code in <a href=https://github.com/ilkerkorkut/go-examples/tree/master/microservice/observability>here</a>.</p><p>To run the application dependencies like prometheus, loki, grafana, tempo and kafka, you can use the docker-compose file inside the container folder. But I have already covered the command in Makefile, so you can call the following command only;</p><p>Running depended services:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>make local-up
</span></span></code></pre></div><p>1- Set the <code>/etc/hosts</code> file for the <code>kafka1</code>, <code>kafka2</code> and <code>kafka3</code> hostnames as <code>127.0.0.1</code> local ip.</p><p>2- <code>.vscode</code> folder contains the initial setup to debug golang application on your local machine. Just be sure that you have installed the <code>delve</code> debugger.</p><p>2.1- Other option; you can build the binary and run directly.(You have to set <code>.env</code> environment variables as well.)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>make build
</span></span></code></pre></div></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/posts/>Posts</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#architecture>Architecture</a></li><li><a href=#prometheus-integration>Prometheus Integration</a></li><li><a href=#sending-custom-metrics-to-prometheus>Sending Custom Metrics to Prometheus</a></li><li><a href=#setting-up-logging-with-zap-to-sink-into-kafka>Setting up Logging with Zap to Sink into Kafka</a></li><li><a href=#distributed-tracing-with-tempo-via-opentelemetry>Distributed Tracing with Tempo via OpenTelemetry</a></li><li><a href=#setting-up-simple-go-microservice-with-fiber>Setting up Simple Go Microservice with Fiber</a></li><li><a href=#exploring-via-grafana-dashboard>Exploring via Grafana Dashboard</a></li><li><a href=#source-code-and-how-to-run-the-application>Source Code and How to run the Application</a></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&text=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&title=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&is_video=false&description=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo&body=Check out this article: https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&title=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&title=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&name=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo&description=In%20this%20post%2c%20I%20will%20try%20to%20demonstrate%20how%20to%20build%20a%20complete%20observability%20solution%20for%20a%20go%20microservice%20with%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Tempo%20and%20interacting%20with%20the%20Grafana%20dashboard.%20In%20API%20layer%2c%20I%20will%20use%20Fiber%20framework%20for%20building%20a%20simple%20service.%20If%20you%20are%20in%20a%20hurry%2c%20you%20can%20find%20the%20source%20code%20in%20this%20section.%0aPrerequisites%3a%0aGo%201.22%20Docker%20%28and%20docker-compose%29%20While%20gathering%20logs%2c%20I%20also%20create%20a%20kafka%20sink%20to%20consuming%20logs%20on%20promtail%20for%20loki." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2filkerkorkut.com%2fposts%2fgolang-all-in-one-microservice-observability%2f&t=All-in-One%20Solution%20for%20observability%20in%20Go%20Microservices%20using%20Prometheus%2c%20Loki%2c%20Promtail%2c%20Grafana%20and%20Tempo" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2024</div><div class=footer-right><nav><ul><li><a href=/posts/>Posts</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>